<style>
  #map label { width: auto; display:inline; }
  #map img { max-width: none; }

  #legend {
    background: white;
    border: solid 1px black;
    padding: 0px 10px 5px 10px;
    text-align: left;
  }

  #legend img { display: inline; }

  #legend h1 {
    font-size: 1.2em;
    font-weight: bold;
    margin: 5px 0px 5px 0px;
  }
</style>

<h3>Welcome</h3>
<p><%= link_to 'Users:', users_path %> <%= User.count %> registered</p>

<% cache ["map", @spot_group] do %>
  <div style='width: 100%;'>
    <div id="map" style='width: 100%; height: 600px;'></div>
  </div>
  <div id="legend">
    <h1><%= @spot_group.name %></h1>
  </div>

  <script>
    <% json = @spot_group.to_arr_for_json.to_json.html_safe %>

    function initialize() {
      var json = $.parseJSON('<%= json %>');

      var mapOptions = {
        mapTypeId: google.maps.MapTypeId.TERRAIN
      };

      var map = new google.maps.Map($('#map')[0], mapOptions),
          pathCoordinates = [],
          bounds = new google.maps.LatLngBounds(),
          infowindow = new google.maps.InfoWindow();

      // Legend
      // https://developers.google.com/maps/tutorials/customizing/adding-a-legend
      var legend = $('#legend')

      $.each(json, function(feed_id, feed) {
        var color = feed.color,
            messages = feed.messages;

        // Legend
        var div = $('<div></div>'),
            chst = 'd_map_spin&chld=0.3|0|' + color + '|10|_|',
            markImg = new google.maps.MarkerImage(
                            'http://chart.apis.google.com/' +
                            'chart?chst=' + chst),
            html = '<div><img src="' + markImg.url + '"> ' + feed.display_name + '</div>'
        legend.append(html);

        // Create path
        $.each(messages, function(idx, obj) {
          if (idx > 0) {
            p1 = new google.maps.LatLng(messages[idx-1].lat,
                                        messages[idx-1].lng);
            p2 = new google.maps.LatLng(obj.lat, obj.lng);

            var path = new google.maps.Polyline({
              path: [p1, p2],
              geodesic: true,
              strokeColor: '#' + color,
              strokeOpacity: 1.0,
              strokeWeight: 4,
              map: map
            });

            createInfoWindow(path, obj.line_info);
          }
        });

        // Create markers
        var markers = [];
        $.each(messages, function(idx, obj) {
          // doc:
          // https://developers.google.com/chart/image/docs/gallery/dynamic_icons#scalable_pins
          // chld=<scale_factor>|
          //      <rotation_deg>|
          //      <fill_color>|
          //      <font_size>|
          //      <font_style>|
          //      <text_line_1>|...|<text_line_n>
          var chst = 'd_map_spin&chld=0.5|0|' + color + '|10|_|' + idx;
          var markImg=new google.maps.MarkerImage(
            'http://chart.apis.google.com/' +
            'chart?chst=' + chst);

          var marker = new google.maps.Marker({
            map: map,
            position: new google.maps.LatLng(obj.lat, obj.lng),
            icon: markImg,
            animation: google.maps.Animation.DROP
          });

          markers.push(marker);

          bounds.extend(marker.position);

          google.maps.event.addListener(marker, 'click', (function(marker, idx) {
            return function() {
              infowindow.setContent(obj.title);
              infowindow.open(map, marker);
            }
          })(marker, idx));
        });

        //group markers; page loads a lot faster when you have many markers
        var mc = new MarkerClusterer(map, markers);
      });

      // Legend
      map.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(legend[0]);

      function createInfoWindow(poly, content) {
        google.maps.event.addListener(poly, 'click', function(event) {
          infowindow.close();
          infowindow = new google.maps.InfoWindow({
            position: event.latLng,
            content: content
          });
          infowindow.open(map);
        });
      }

      // Zoom to markers
      map.fitBounds(bounds);
    }


    google.maps.event.addDomListener(window, 'load', initialize);
  </script>
<% end # cache %>
